# MVP-1 Design: sim_daemon + React UI

## Status: Approved

---

## 1. Scope

Add two new components to the workspace:

- `crates/sim_daemon` (bin) — axum HTTP server running the tick loop
- `ui_web/` — Vite + React + TypeScript mission control dashboard

`sim_cli` is unchanged. `sim_daemon` is a parallel runner for the live UI use case.

**Out of scope for MVP-1:** write APIs (POST /commands), save/load persistence, travel mechanics, ScenarioSource wiring.

---

## 2. Workspace Changes

```
crates/
  sim_daemon/     (new bin crate)
    Cargo.toml
    src/main.rs
ui_web/           (new React app, not a Rust crate)
  package.json
  vite.config.ts
  src/
    main.tsx
    App.tsx
    components/
      StatusBar.tsx
      EventsFeed.tsx
      AsteroidTable.tsx
      ResearchPanel.tsx
    hooks/
      useSimStream.ts
    types.ts
```

Dependency graph:
```
sim_daemon → sim_core, sim_control
```

---

## 3. sim_daemon

### CLI Interface

```
sim_daemon run \
  --seed <u64>                    # required
  [--content-dir ./content]       # default: ./content
  [--port 3001]                   # default: 3001
  [--ticks-per-sec 10]            # default: 10; 0 = as-fast-as-possible
  [--max-ticks <u64>]             # optional; daemon stops after N ticks
```

### Shared State

```rust
struct SimState {
    game_state: GameState,
    content: GameContent,
    rng: ChaCha8Rng,
    autopilot: AutopilotController,
    next_command_id: u64,
}

type SharedSim = Arc<Mutex<SimState>>;
type EventTx = tokio::sync::broadcast::Sender<Vec<EventEnvelope>>;
```

### Tick Loop (tokio task)

```
loop:
  1. Lock SharedSim
  2. Generate autopilot commands
  3. Run sim_core::tick → Vec<EventEnvelope>
  4. Unlock
  5. Broadcast events via EventTx (drop if no subscribers)
  6. If ticks_per_sec > 0: sleep(1s / ticks_per_sec - elapsed)
     Else: yield to tokio scheduler (tokio::task::yield_now)
  7. If max_ticks reached: break
```

### HTTP Endpoints (axum)

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/v1/meta` | Returns tick, seed, content_version |
| GET | `/api/v1/snapshot` | Returns full GameState as JSON |
| GET | `/api/v1/stream` | SSE stream of EventEnvelope batches |

**SSE format** (`/api/v1/stream`):
- Each tick's events sent as one SSE message: `data: <json array>\n\n`
- Heartbeat every 5s: `data: {"heartbeat":true,"tick":<n>}\n\n`
- Client subscribes to a `broadcast::Receiver` on connection

**CORS:** Allow `http://localhost:5173` (Vite dev server origin).

### Cargo.toml dependencies

```toml
sim_core = { path = "../sim_core" }
sim_control = { path = "../sim_control" }
tokio = { version = "1", features = ["full"] }
axum = { version = "0.7", features = ["macros"] }
tower-http = { version = "0.5", features = ["cors"] }
serde = { version = "1", features = ["derive"] }
serde_json = "1"
rand = "0.8"
rand_chacha = "0.3"
anyhow = "1"
clap = { version = "4", features = ["derive"] }
```

---

## 4. React UI

### Layout

```
┌─────────────────────────────────────────────────────────┐
│  STATUS BAR: tick | day/hour | speed | connection status │
├────────────────┬──────────────────┬─────────────────────┤
│  EVENTS FEED   │  ASTEROID TABLE  │  RESEARCH PANEL     │
│  (live scroll) │                  │                     │
│  evt_000123    │  ID | Tags | Fe% │  tech_deep_scan_v1  │
│  TechUnlocked  │  ast_0001 IronR  │  evidence: 142.3    │
│  evt_000124    │  ast_0002  -     │  p(unlock): 51%     │
│  AsteroidDisc  │  ...             │  status: unlocked   │
└────────────────┴──────────────────┴─────────────────────┘
```

### Data Flow

1. On mount: `GET /api/v1/snapshot` → hydrate asteroid table + research panel + set initial tick
2. Connect `EventSource` to `GET /api/v1/stream`
3. On each SSE message: prepend events to feed; update asteroid/research state from events (no re-fetch)
4. On heartbeat: update tick/status bar

### State Shape (TypeScript)

```ts
interface SimSnapshot {
  meta: { tick: number; seed: number; content_version: string }
  asteroids: Record<string, Asteroid>
  research: { unlocked: string[]; data_pool: Record<string, number>; evidence: Record<string, number> }
}

interface Asteroid {
  id: string
  location_node: string
  knowledge: {
    tag_beliefs: [string, number][]
    composition: Record<string, number> | null
  }
}

type SimEvent = { id: string; tick: number; event: Record<string, unknown> }
```

### State Management

Single `useReducer` at App level. Actions:
- `SNAPSHOT_LOADED` — set initial state
- `EVENTS_RECEIVED` — prepend to feed, patch asteroids/research
- `HEARTBEAT` — update tick display
- `DISCONNECTED` / `CONNECTED` — update status bar

### Styling

Plain CSS (no component library). Dark theme, monospace font for numbers. Three-column flex layout.

---

## 5. Success Criteria

- `sim_daemon run --seed 42` starts and runs the sim at 10 ticks/sec
- `GET /api/v1/snapshot` returns valid JSON matching GameState shape
- `GET /api/v1/stream` streams events in real-time
- React UI connects, hydrates from snapshot, shows live event feed
- Asteroid table populates as AsteroidDiscovered events arrive
- Research panel shows evidence accumulation and tech unlock
- No CORS errors; UI and daemon can run simultaneously in dev

---

## 6. Out of Scope

- Persistence (saves/) — deferred to a later milestone
- POST /api/v1/commands — deferred
- ScenarioSource wiring
- sim_cli changes
